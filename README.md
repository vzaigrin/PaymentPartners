# Partners of the Payment System
Проектная работа курса [Data Engineer](https://otus.ru/lessons/data-engineer/) от Otus.

Проект основан на реальной системе. Для предотвращения раскрытия коммерческой информации название сервиса и компаний-партнёров изменены.

## Задание
Сервис платёжной системы для своих партнёров.

Платёжная система предоставляет своим партнёрам программы привелегий. Партнеры предоставляют привелегии держателям карт. Партнёры загружают данные о предоставленных привилегиях держателям карт. Передача информации о привилегиях осуществляется путём загрузки в систему реестров, представляющих собой текстовые файлы в формате CSV. Партнёры загружают данные в своих форматах. Загруженные данные преобразуются к единому формату.

Отчётным периодом в системе является календарный месяц. Приём информации от партнёров по отчётному периоду длится в течение периода сбора, который начинается в первый день месяца, следующего за отчётным периодом, и длится в течение 15 дней. По истечении периода сбора расчётный период закрывается и блокируется, становясь недоступным для внесения в него каких-либо изменений. По итогам закрытия расчётного периода осуществляется формирование отчётности.

Список партнёров может меняться. Исходный список партнёров:
- Taxi
- Telecom
- Cinema
- Retail

## Архитектура
...

## Реализация
Система реализована на сервисах [Google Cloud Platform](https://cloud.google.com):
- Файлы с данными загружаются в [Cloud Storage](https://cloud.google.com/storage/)
- Для DWH используется [BigQuery](https://cloud.google.com/bigquery/)
- В качестве планировщика используется [Cloud Scheduler](https://cloud.google.com/scheduler/)
- Для передачи сообщений используется [Cloud Pub/Sub](https://cloud.google.com/pubsub/)
- Скрипты [Cloud Functions](https://cloud.google.com/functions/) срабатывают по событиям
- Для построения отчётов используется [Data Studio](datastudio.google.com)

### DWH
Для моделирование DWH используется метод [Data Vault](https://en.wikipedia.org/wiki/Data_vault_modeling).

Исходный код (DDL) таблиц и процедур находится в папке *DWH*

#### Stage
Справочники могут быть сразу созданы в детальном слое. Но так как они могут измениться, они подаются в систему в виде файлов и проходят все этапы обработки.
Справочники загружаются в область dicts. Партнёры загружают реестры в виде файлов в область inbox в папку со своим именем.

Входящие файлы без изменений попадают в область Stage:
- STG_PARTNERS - справочник партёров
- STG_BINS - справочник Bins (первые 6 цифр карт)
- STG_PRIVILEGES - справочник привелегий
- STG_TAXI - данные партнёра Taxi
- STG_TELECOM - данные партнёра Telecom
- STG_CINEMA - данные партнёра Cinema
- STG_RETAIL - данные партнёра Retail

#### ODS
Справочники очищаются и перегружаются в область ODS сразу после загрузки в область Stage:
- ODS_PARTNERS - справочник партёров
- ODS_BINS - справочник Bins (первые 6 цифр карт)
- ODS_PRIVILEGES - справочник привелегий

Реестры (данные, загружаемые партнёрами) перегружаются в область ODS по окончании периода сбора данных (16-го числа следующего месяца).
Реестры проверяются и очищаются. Перегружаются только корректные записи отчётного периода:
- ODS_TAXI - данные партнёра Taxi
- ODS_TELECOM - данные партнёра Telecom
- ODS_CINEMA - данные партнёра Cinema
- ODS_RETAIL - данные партнёра Retail

#### DDS
Данные из области ODS приводятся к единому формату и перегружаются в область DDS:
- Партнёры:
  - HUB_PARTNERS
  - SAT_PARTNERS
- Данные:
  - HUB_DATA
  - SAT_DATA
  - LNK_DATA_PARTNERS
  - LNK_DATA_BINS
  - LNK_DATA_PRIVILEGES
- Справочник Bins:
  - HUB_BINS
  - SAT_BINS
- Справочник привелегий
  - HUB_PRIVILEGES
  - SAT_PRIVILEGES

#### Data Marts
По данным из DDS строятся отчёты в области Data Marts:
- DM_LOADS - отчёты о загрузках данных
- DM_REPORT - отчёты рассчётных периодов
- V_DM_CARD - отчёт по типам карт
- V_DM_BANK - отчёт по банкам
- V_DM_CITY - отчёт по городам
- V_DM_PRIVILEGE - отчёт по типам привилегий
- V_DM_PAYMENT - отчёт по среднему чеку

#### Процедуры обработки данных
Для заполнения данными таблиц в DWH созданы специальные процедуры:
- LOAD_PARTNERS() - загрузка данных о партнёрах в слой DDS
- LOAD_BINS() - загрузка данных о bins в слой DDS
- LOAD_PRIVILEGE() - загрузка данных о привилегиях в слой DDS
- LOAD_TAXI() - загрузка данных партнёра Taxi во временные таблицы слоя DDS
- LOAD_TELECOM() - загрузка данных партнёра Telecom во временные таблицы слоя DDS
- LOAD_CINEMA() - загрузка данных партнёра Cinema во временные таблицы слоя DDS
- LOAD_RETAIL() - загрузка данных партнёра Retail во временные таблицы слоя DDS
- LOAD_DATA() - перегрузка данных из временных таблиц в слой DDS
- DATA2DM() - заполнение витрины слоя DM отчётом за конкретный период

Таблицы и процедуры создаются в наборе данных PP.

#### Наборы данных для партнёров
Так как разграничение доступа к данным в BigQuery осуществляется на уровне наборов данных, для каждого партнёра создаётся свой набор данных с названием, совпадающем с именем партнёра. Эти наборы содержат представления (View) с витринами, содержащие данные только одного партнёра.

Для единообразия витрины называются одинаково:
- V_DM_LOADS - отчёты о загрузках данных
- V_DM_CARD - отчёт по типам карт
- V_DM_BANK - отчёт по банкам
- V_DM_CITY - отчёт по городам
- V_DM_PRIVILEGE - отчёт по типам привилегий
- V_DM_PAYMENT - отчёт по среднему чеку

### Загрузка данных
При загрузки файлов со справочниками в Storage срабатывает функция **LoadDicts**. Файлы со справочниками должны называться так же как называются таблицы справочников, и должны содержать весь справочник.

Для обработки файлов с реестрами по расписанию (16-го числа каждого месяца в 0:0) планировщик Scheduler через систему Pub/Sub посылает сообщение, которое запускает функцию **LoadData**.

Обе функции:
- загружают данные из файлов в область Stage
- вызывают процедуру перегрузки данных из области Stage в области ODS и DDS
- удаляют файлы

Исторические данные (реестры за прошлые периоды) в Cloud Storage не выгружаются. Для их загрузки используется скрипт **load_hist_data**. Он загружает данные из файлов в область Stage, вызывает процедуру перегрузки данных в области ODS и DDS, а затем вызывает процедуру заполнения витрины DM отчётом за предыдущие периоды. Файлы с данными не удаляются.

Исходный код функций загрузки данных находится в папке *src/data-load*

## Данные

Данные находятся в папке *data*

### Реестры
Для предотвращения раскрытия коммерческой информации используются сгенерированные синтетические данные. Данные генерируются специальным скриптом **data-gen** по шаблонам, описывающих поля и их значения.

Вызов: **data-gen** <-t | --template> filename
                <-o | --output> filename") 
                <-y | --year> number") 
                <-m | --month> number") 
                [<-n | --number-lines> number]") 
                [<-e | --errors> number]") 
                [<-v | --verbose>]") 
                [<-h | --help>]") 
 
 где:
  - template - файл с шаблоном
  - output - файл со сгенерированными данными
  - year - год, для генерации дат
  - month - месяц, для генерации дат
  - number-lines - кол-во генерируемых записей, по умолчанию - 100000
  - errors - процент записей с ошибками, по умолчанию - 0
  - verbose - флаг вывода информации о работе
  - help - вывод этой информации

Скрипт **gen2019.sh** генерирует данные за весь 2019 год для всех шаблонов с 100000 записей с 10% ошибок в каждом месяце для каждого партнёра.

Исходный код генератора данных находится в папке *src/data-gen*

### Справочники
В системе предусмотрено наличие справочников:
- Bins - справочник Bins (первые 6 цифр карт)
- Privileges - справочник привелегий

В справочниках коммерческие данные анонимизированы.

## Отчёты
По витринам слоя DM построены отчёты в Data Studio:
- [Загрузки](https://datastudio.google.com/reporting/0647ce66-575e-425f-b565-9bd6f15be617)
- [Регионы](https://datastudio.google.com/reporting/0ad44459-d2a3-479b-82a1-e2c68d530653)

Для каждого партнёра построен свой набор отчётов:

### Cinema
- [Загрузки](https://datastudio.google.com/reporting/032d3d19-77ed-4370-9a26-788d672c97c4)

### Retail
- [Загрузки](https://datastudio.google.com/reporting/9fea0417-17e3-4f14-b69f-aaf08f1623af)

### Taxi
- [Загрузки](https://datastudio.google.com/reporting/9788609e-b4c1-46a4-b4c6-a6ce53390d0c)

### Telecom
- [Загрузки](https://datastudio.google.com/reporting/39b856c2-b223-416c-a23f-a2dcb3643f09)

## Развитие
Для полноты реализации в систему планируется добавить пользовательское приложение в виде web-сервиса для загрузки данных и просмотров отчётов.

## Перспектива
В дальнейшем к системе можно будет добавить обработку потоковых данных о транзакциях партнёров.
