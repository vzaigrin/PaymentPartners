# Partners of the Payment System
Проектная работа курса [Data Engineer](https://otus.ru/lessons/data-engineer/) от Otus.

Проект основан на реальной системе. Для предотвращения раскрытия коммерческой информации название сервиса и компаний-партнёров изменены.

## Задание
Сервис платёжной системы для своих партнёров. Список партнёров может меняться.

Список партнёров на текущий момент:
- Taxi
- Telecom
- Cinema
- Retail

Платёжная система предоставляет своим партнёрам программы привелегий. Партнеры предоставляют привелегии держателям карт. Партнёры загружают данные о предоставленных привилегиях держателям карт. Передача информации о привилегиях осуществляется путём загрузки в систему реестров, представляющих собой текстовые файлы в формате CSV. Партнёры загружают данные в своих форматах. Загруженные данные преобразуются к единому формату.

Отчётным периодом в системе является календарный месяц. Приём информации от партнёров по отчётному периоду длится в течение периода сбора, который начинается в первый день месяца, следующего за отчётным периодом, и длится в течение 15 дней. По истечении периода сбора расчётный период закрывается и блокируется, становясь недоступным для внесения в него каких-либо изменений. По итогам закрытия расчётного периода осуществляется формирование отчётности.

## Данные
Для предотвращения раскрытия коммерческой информации используются генерированные синтетические данные. Данные генерируются специальным скриптом **data-gen** по шаблонам, описывающих поля и их значения.

Вызов: **data-gen** <-t | --template> filename
                <-o | --output> filename") 
                <-y | --year> number") 
                <-m | --month> number") 
                [<-n | --number-lines> number]") 
                [<-e | --errors> number]") 
                [<-v | --verbose>]") 
                [<-h | --help>]") 
 
 где:
  - template - файл с шаблоном
  - output - файл со сгенерированными данными
  - year - год, для генерации дат
  - month - месяц, для генерации дат
  - number-lines - кол-во генерируемых записей, по умолчанию - 100000
  - errors - процент записей с ошибками, по умолчанию - 0
  - verbose - флаг вывода информации о работе
  - help - вывод этой информации

Скрипт **gen2019.sh** генерирует данные за весь 2019 год для всех шаблонов с 100000 записей с 10% ошибок в каждом месяце для каждого партнёра.

В справочниках коммерческие данные анонимизированы.

## Реализация
Система реализована на сервисах [Google Cloud Platform](https://cloud.google.com):
- Данные загружаются в [Cloud Storage](https://cloud.google.com/storage/)
- Для DWH используется [BigQuery](https://cloud.google.com/bigquery/)

При загрузки файлов со справочниками в систему срабатывает скрипт [Cloud Functions](https://cloud.google.com/functions/) **load_data**, который:
- загружает данные из файла в область Stage DWH
- вызывает процедуру перегрузки данных в области ODS и DDS
- удаляет файл

Для обработки файлов с реестрами запускается процедура по расписанию (16-го числа каждого месяца в 0:0).

## DWH
Для моделирование DWH используется метод [Data Vault](https://en.wikipedia.org/wiki/Data_vault_modeling)

### Stage
Справочники могут быть сразу созданы в детальном слое. Но так как они могут измениться, они подаются в систему в виде файлов и проходят все этапы обработки.
Справочники загружаются в область dicts. Партнёры загружают реестры в виде файлов в область inbox в папку со своим именем. После обработки файлы перекладываются в папку archive.

Входящие файлы без изменений попадают в область Stage:
- STG_PARTNERS - справочник партёров
- STG_BINS - справочник Bins (первые 6 цифр карт)
- STG_PRIVILEGES - справочник привелегий
- STG_TAXI - данные партнёра Taxi
- STG_TELECOM - данные партнёра Telecom
- STG_CINEMA - данные партнёра Cinema
- STG_RETAIL - данные партнёра Retail

### ODS
Справочники очищаются и перегружаются в область ODS сразу после загрузки в область Stage:
- ODS_PARTNERS - справочник партёров
- ODS_BINS - справочник Bins (первые 6 цифр карт)
- ODS_PRIVILEGES - справочник привелегий

Реестры (данные, загружаемые партнёрами) перегружаются в область ODS по окончании периода сбора данных (16-го числа следующего месяца).
Реестры проверяются и очищаются. Перегружаются только корректные записи отчётного периода:
- ODS_TAXI - данные партнёра Taxi
- ODS_TELECOM - данные партнёра Telecom
- ODS_CINEMA - данные партнёра Cinema
- ODS_RETAIL - данные партнёра Retail

### DDS
Данные из области ODS приводятся к единому формату и перегружаются в область DDS:
- Партнёры:
  - HUB_PARTNERS
  - V_HUB_PARTNERS - представление с актуальным списком партнёров
  - SUB_PARTNERS
- Данные:
  - HUB_DATA
  - SUB_DATA
  - LNK_DATA_PARTNERS
  - LNK_DATA_BINS
  - LNK_DATA_PRIVILEGES
- Справочник Bins:
  - HUB_BINS
  - V_HUB_BINS - представление с актуальным списком Bins
  - SUB_BINS
- Справочник привелегий
  - HUB_PRIVILEGES
  - V_HUB_PRIVILEGES - представление с актуальным списком привелегий
  - SUB_PRIVILEGES

### Data Marts
По данным из DDS строятся отчёты в области Data Marts:
- DM_LOADS - отчёты о загрузках данных
- DM_REPORT - отчёт за расчётный период
- V_DM_CARD - отчёт по типам карт
- V_DM_BANK - отчёт по банкам
- V_DM_CITY - отчёт по горадам
- V_DM_PURCHASE - отчёт по услугам
- V_DM_PRIVILEGE - отчёт по типам привилегий
- V_DM_PAYMENT - отчёт по среднему чеку
- V_DM_CARD_TAXI - отчёт по типам карт для партнёра Taxi
- V_DM_BANK_TAXI - отчёт по банкам для партнёра Taxi
- V_DM_CITY_TAXI - отчёт по горадам для партнёра Taxi
- V_DM_PURCHASE_TAXI - отчёт по услугам для партнёра Taxi
- V_DM_PRIVILEGE_TAXI - отчёт по типам привилегий для партнёра Taxi
- V_DM_PAYMENT_TAXI - отчёт по среднему чеку для партнёра Taxi
- V_DM_CARD_TELECOM - отчёт по типам карт для партнёра Telecom
- V_DM_BANK_TELECOM - отчёт по банкам для партнёра Telecom
- V_DM_CITY_TELECOM - отчёт по горадам для партнёра Telecom
- V_DM_PURCHASE_TELECOM - отчёт по услугам для партнёра Telecom
- V_DM_PRIVILEGE_TELECOM - отчёт по типам привилегий для партнёра Telecom
- V_DM_PAYMENT_TELECOM - отчёт по среднему чеку для партнёра Telecom
- V_DM_CARD_CINEMA - отчёт по типам карт для партнёра Cinema
- V_DM_BANK_CINEMA - отчёт по банкам для партнёра Cinema
- V_DM_CITY_CINEMA - отчёт по горадам для партнёра Cinema
- V_DM_PURCHASE_CINEMA - отчёт по услугам для партнёра Cinema
- V_DM_PRIVILEGE_CINEMA - отчёт по типам привилегий для партнёра Cinema
- V_DM_PAYMENT_CINEMA - отчёт по среднему чеку для партнёра Cinema
- V_DM_CARD_RETAIL - отчёт по типам карт для партнёра Retail
- V_DM_BANK_RETAIL - отчёт по банкам для партнёра Retail
- V_DM_CITY_RETAIL - отчёт по горадам для партнёра Retail
- V_DM_PURCHASE_RETAIL - отчёт по услугам для партнёра Retail
- V_DM_PRIVILEGE_RETAIL - отчёт по типам привилегий для партнёра Retail
- V_DM_PAYMENT_RETAIL - отчёт по среднему чеку для партнёра Retail

### Процедуры обработки данных
Для заполнения данными таблиц в область ODS и DDS созданы специальные процедуры:
- LOAD_PARTNERS() - данные о партнёрах
- LOAD_BINS() - данные о bins
- LOAD_PRIVILEGE() - данные о привилегиях

## Развитие
Для полноты реализации в систему планируется добавить дашборды для витрин и пользовательское приложение в виде web-сервиса для загрузки данных и просмотров отчётов.

## Перспектива
В дальнейшем к системе можно будет добавить обработку потоковых данных о транзакциях партнёров.
